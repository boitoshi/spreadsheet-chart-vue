<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
.ic-container {
    max-width: 900px; margin: 0 auto; padding: 20px;
    font-family: -apple-system, BlinkMacSystemFont,
        "Segoe UI", Roboto, sans-serif;
}
.ic-title {
    font-size: 20px; font-weight: 700;
    margin-bottom: 16px; color: #1a1a1a;
}
.ic-date-label {
    font-size: 13px; font-weight: 400;
    color: #94a3b8; margin-left: 8px;
}
.ic-view-tabs {
    display: flex; gap: 4px; margin-bottom: 16px;
    background: #f1f5f9; border-radius: 8px;
    padding: 4px;
}
.ic-view-tab {
    flex: 1; padding: 10px 16px; background: none;
    border: none; border-radius: 6px; cursor: pointer;
    font-size: 14px; font-weight: 500; color: #64748b;
    transition: all 0.2s;
}
.ic-view-tab:hover { color: #334155; }
.ic-view-tab.active {
    background: white; color: #2563eb;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}
.ic-stock-tabs, .ic-period-tabs {
    display: flex; gap: 8px; margin-bottom: 16px;
    flex-wrap: wrap;
}
.ic-stock-tab {
    padding: 8px 18px; background: #f8fafc;
    border: 1px solid #e2e8f0; border-radius: 20px;
    cursor: pointer; font-size: 13px; font-weight: 500;
    color: #475569; transition: all 0.2s;
}
.ic-stock-tab:hover {
    border-color: #2563eb; color: #2563eb;
}
.ic-stock-tab.active {
    background: #2563eb; border-color: #2563eb;
    color: white;
}
.ic-chart-wrapper {
    position: relative; height: 400px;
    background: white; padding: 16px;
    border-radius: 12px; border: 1px solid #e2e8f0;
}
.ic-info {
    margin-top: 16px; padding: 16px;
    background: #f8fafc; border-radius: 10px;
    display: grid;
    grid-template-columns:
        repeat(auto-fit, minmax(180px, 1fr));
    gap: 12px;
}
.ic-info-item {
    display: flex; flex-direction: column;
}
.ic-info-label {
    font-size: 11px; color: #94a3b8;
    margin-bottom: 4px; text-transform: uppercase;
    letter-spacing: 0.05em;
}
.ic-info-value {
    font-size: 18px; font-weight: 600;
    color: #1e293b;
}
.ic-info-value.positive { color: #16a34a; }
.ic-info-value.negative { color: #dc2626; }
@media (max-width: 600px) {
    .ic-container { padding: 12px; }
    .ic-title { font-size: 16px; margin-bottom: 12px; }
    .ic-chart-wrapper { height: 280px; padding: 10px; }
    .ic-stock-tab {
        padding: 6px 12px; font-size: 12px;
    }
    .ic-view-tab {
        padding: 8px 10px; font-size: 13px;
    }
    .ic-info {
        grid-template-columns: 1fr 1fr;
        gap: 8px; padding: 12px;
    }
    .ic-info-value { font-size: 15px; }
    .ic-info-label { font-size: 10px; }
}
@media (max-width: 380px) {
    .ic-info {
        grid-template-columns: 1fr;
    }
}
</style>
<div class="ic-container">
    <div class="ic-title">DeNA (2432.T)
        <span class="ic-date-label">2026年1月末時点</span>
    </div>
    
    <div class="ic-period-tabs" id="periodTabs">
        <button class="ic-stock-tab" data-period="1m">
            1M</button>
        <button class="ic-stock-tab active"
            data-period="6m">6M</button>
        <button class="ic-stock-tab" data-period="1y">
            1Y</button>
    </div>
    <div class="ic-chart-wrapper">
        <canvas id="icChart"></canvas>
    </div>
    <div class="ic-info" id="icInfo"></div>
</div>
<script>
(function() {
const S = {"symbol": "2432.T", "dates": ["2024-10-02", "2024-10-03", "2024-10-04", "2024-10-07", "2024-10-08", "2024-10-09", "2024-10-10", "2024-10-11", "2024-10-15", "2024-10-16", "2024-10-17", "2024-10-18", "2024-10-21", "2024-10-22", "2024-10-23", "2024-10-24", "2024-10-25", "2024-10-28", "2024-10-29", "2024-10-30", "2024-10-31", "2024-11-01", "2024-11-05", "2024-11-06", "2024-11-07", "2024-11-08", "2024-11-11", "2024-11-12", "2024-11-13", "2024-11-14", "2024-11-15", "2024-11-18", "2024-11-19", "2024-11-20", "2024-11-21", "2024-11-22", "2024-11-25", "2024-11-26", "2024-11-27", "2024-11-28", "2024-11-29", "2024-12-02", "2024-12-03", "2024-12-04", "2024-12-05", "2024-12-06", "2024-12-09", "2024-12-10", "2024-12-11", "2024-12-12", "2024-12-13", "2024-12-16", "2024-12-17", "2024-12-18", "2024-12-19", "2024-12-20", "2024-12-23", "2024-12-24", "2024-12-25", "2024-12-26", "2024-12-27", "2024-12-30", "2025-01-06", "2025-01-07", "2025-01-08", "2025-01-09", "2025-01-10", "2025-01-14", "2025-01-15", "2025-01-16", "2025-01-17", "2025-01-20", "2025-01-21", "2025-01-22", "2025-01-23", "2025-01-24", "2025-01-27", "2025-01-28", "2025-01-29", "2025-01-30", "2025-01-31", "2025-02-03", "2025-02-04", "2025-02-05", "2025-02-06", "2025-02-07", "2025-02-10", "2025-02-12", "2025-02-13", "2025-02-14", "2025-02-17", "2025-02-18", "2025-02-19", "2025-02-20", "2025-02-21", "2025-02-25", "2025-02-26", "2025-02-27", "2025-02-28", "2025-03-03", "2025-03-04", "2025-03-05", "2025-03-06", "2025-03-07", "2025-03-10", "2025-03-11", "2025-03-12", "2025-03-13", "2025-03-14", "2025-03-17", "2025-03-18", "2025-03-19", "2025-03-21", "2025-03-24", "2025-03-25", "2025-03-26", "2025-03-27", "2025-03-28", "2025-03-31", "2025-04-01", "2025-04-02", "2025-04-03", "2025-04-04", "2025-04-07", "2025-04-08", "2025-04-09", "2025-04-10", "2025-04-11", "2025-04-14", "2025-04-15", "2025-04-16", "2025-04-17", "2025-04-18", "2025-04-21", "2025-04-22", "2025-04-23", "2025-04-24", "2025-04-25", "2025-04-28", "2025-04-30", "2025-05-01", "2025-05-02", "2025-05-07", "2025-05-08", "2025-05-09", "2025-05-12", "2025-05-13", "2025-05-14", "2025-05-15", "2025-05-16", "2025-05-19", "2025-05-20", "2025-05-21", "2025-05-22", "2025-05-23", "2025-05-26", "2025-05-27", "2025-05-28", "2025-05-29", "2025-05-30", "2025-06-02", "2025-06-03", "2025-06-04", "2025-06-05", "2025-06-06", "2025-06-09", "2025-06-10", "2025-06-11", "2025-06-12", "2025-06-13", "2025-06-16", "2025-06-17", "2025-06-18", "2025-06-19", "2025-06-20", "2025-06-23", "2025-06-24", "2025-06-25", "2025-06-26", "2025-06-27", "2025-06-30", "2025-07-01", "2025-07-02", "2025-07-03", "2025-07-04", "2025-07-07", "2025-07-08", "2025-07-09", "2025-07-10", "2025-07-11", "2025-07-14", "2025-07-15", "2025-07-16", "2025-07-17", "2025-07-18", "2025-07-22", "2025-07-23", "2025-07-24", "2025-07-25", "2025-07-28", "2025-07-29", "2025-07-30", "2025-07-31", "2025-08-01", "2025-08-04", "2025-08-05", "2025-08-06", "2025-08-07", "2025-08-08", "2025-08-12", "2025-08-13", "2025-08-14", "2025-08-15", "2025-08-18", "2025-08-19", "2025-08-20", "2025-08-21", "2025-08-22", "2025-08-25", "2025-08-26", "2025-08-27", "2025-08-28", "2025-08-29", "2025-09-01", "2025-09-02", "2025-09-03", "2025-09-04", "2025-09-05", "2025-09-08", "2025-09-09", "2025-09-10", "2025-09-11", "2025-09-12", "2025-09-16", "2025-09-17", "2025-09-18", "2025-09-19", "2025-09-22", "2025-09-24", "2025-09-25", "2025-09-26", "2025-09-29", "2025-09-30", "2025-10-01", "2025-10-02", "2025-10-03", "2025-10-06", "2025-10-07", "2025-10-08", "2025-10-09", "2025-10-10", "2025-10-14", "2025-10-15", "2025-10-16", "2025-10-17", "2025-10-20", "2025-10-21", "2025-10-22", "2025-10-23", "2025-10-24", "2025-10-27", "2025-10-28", "2025-10-29", "2025-10-30", "2025-10-31", "2025-11-04", "2025-11-05", "2025-11-06", "2025-11-07", "2025-11-10", "2025-11-11", "2025-11-12", "2025-11-13", "2025-11-14", "2025-11-17", "2025-11-18", "2025-11-19", "2025-11-20", "2025-11-21", "2025-11-25", "2025-11-26", "2025-11-27", "2025-11-28", "2025-12-01", "2025-12-02", "2025-12-03", "2025-12-04", "2025-12-05", "2025-12-08", "2025-12-09", "2025-12-10", "2025-12-11", "2025-12-12", "2025-12-15", "2025-12-16", "2025-12-17", "2025-12-18", "2025-12-19", "2025-12-22", "2025-12-23", "2025-12-24", "2025-12-25", "2025-12-26", "2025-12-29", "2025-12-30", "2026-01-05", "2026-01-06", "2026-01-07", "2026-01-08", "2026-01-09", "2026-01-13", "2026-01-14", "2026-01-15", "2026-01-16", "2026-01-19", "2026-01-20", "2026-01-21", "2026-01-22", "2026-01-23", "2026-01-26", "2026-01-27", "2026-01-28", "2026-01-29", "2026-01-30"], "closes": [1689.97, 1696.85, 1682.6, 1714.53, 1740.06, 1780.34, 1769.04, 1751.85, 1710.11, 1727.3, 1731.72, 1782.3, 1763.64, 1721.4, 1716.0, 1695.86, 1708.63, 1770.02, 1800.96, 1737.12, 1852.53, 1798.51, 1828.96, 1928.17, 2021.48, 2066.17, 2423.22, 2262.13, 2214.98, 2225.3, 2214.98, 2244.94, 2303.88, 2425.19, 2491.98, 2472.34, 2402.1, 2448.76, 2422.73, 2475.28, 2394.25, 2394.25, 2394.25, 2457.11, 2489.53, 2500.33, 2429.61, 2405.54, 2406.52, 2527.83, 2572.53, 2686.47, 2733.12, 2636.86, 2650.12, 2646.69, 2679.59, 2602.98, 2598.06, 2647.18, 3059.72, 3079.37, 2840.68, 2818.58, 2789.6, 2717.41, 2661.91, 2702.67, 2744.91, 2730.18, 2532.74, 2491.0, 2524.89, 2584.8, 2617.71, 2711.51, 2666.82, 2675.17, 2655.04, 2769.96, 2691.38, 2775.85, 2868.18, 2892.74, 3015.52, 2978.2, 3665.78, 3530.22, 3664.79, 3615.68, 3530.22, 3494.86, 3477.18, 3471.29, 3953.58, 3903.48, 3846.51, 3900.53, 3914.29, 3606.84, 3535.14, 3462.45, 3546.92, 3319.04, 3254.21, 3235.55, 3231.62, 3267.96, 3308.23, 3234.57, 3292.52, 3300.38, 3434.95, 3442.8, 3570.5, 3645.15, 3598.0, 3730.0, 3510.0, 3414.0, 3520.0, 3436.0, 3296.0, 2946.5, 3179.0, 3052.0, 3374.0, 3428.0, 3492.0, 3462.0, 3353.0, 3465.0, 3555.0, 3473.0, 3584.0, 3559.0, 3654.0, 3625.0, 3720.0, 3855.0, 3704.0, 3660.0, 3602.0, 3619.0, 3630.0, 3035.0, 2945.5, 2924.0, 2962.5, 3005.0, 2939.0, 2983.0, 2849.5, 2850.0, 2768.5, 2815.0, 2760.0, 2745.0, 2762.0, 2785.5, 2705.0, 2653.0, 2690.0, 2647.0, 2628.0, 2660.0, 2712.0, 2721.5, 2710.5, 2658.5, 2672.0, 2766.5, 2804.0, 2791.0, 2690.0, 2685.0, 2714.5, 2718.5, 2697.0, 2674.0, 2672.0, 2545.0, 2470.0, 2440.0, 2425.0, 2409.5, 2418.5, 2429.5, 2388.5, 2410.5, 2373.0, 2359.0, 2366.5, 2420.5, 2399.0, 2370.0, 2450.0, 2420.0, 2381.0, 2371.5, 2398.0, 2402.0, 2387.0, 2395.0, 2396.5, 2450.0, 2411.0, 2441.0, 2270.0, 2320.0, 2262.5, 2266.0, 2284.5, 2306.0, 2307.0, 2267.5, 2267.0, 2282.5, 2287.5, 2250.0, 2232.0, 2215.0, 2237.5, 2252.0, 2262.5, 2239.0, 2242.5, 2255.0, 2338.0, 2319.0, 2334.0, 2314.5, 2369.5, 2412.5, 2394.0, 2389.0, 2326.0, 2301.5, 2360.5, 2364.5, 2316.0, 2298.0, 2319.5, 2305.5, 2305.0, 2312.5, 2299.0, 2333.0, 2317.0, 2339.0, 2343.5, 2319.0, 2336.0, 2372.0, 2309.5, 2363.5, 2520.0, 2514.0, 2523.0, 2509.5, 2594.5, 2768.5, 2695.5, 2675.5, 2709.0, 2681.0, 2623.0, 2627.5, 2647.5, 2608.0, 2674.5, 2684.5, 2652.5, 2572.5, 2505.0, 2452.5, 2400.0, 2369.0, 2420.5, 2397.0, 2414.0, 2431.0, 2413.0, 2347.0, 2332.5, 2311.0, 2345.5, 2345.5, 2426.5, 2401.0, 2456.0, 2402.5, 2431.5, 2469.0, 2504.0, 2550.0, 2549.5, 2593.5, 2557.0, 2584.0, 2579.0, 2557.0, 2618.0, 2558.0, 2538.0, 2542.0, 2614.5, 2615.0, 2580.0, 2564.5, 2564.0, 2550.0, 2586.0, 2574.5, 2607.0, 2565.0, 2543.0, 2549.5, 2562.5, 2539.5, 2556.0, 2515.5, 2517.0, 2531.0], "highs": [1723.37, 1723.86, 1697.83, 1723.86, 1741.54, 1800.47, 1803.42, 1768.55, 1746.45, 1740.06, 1749.89, 1851.06, 1810.79, 1769.04, 1743.01, 1746.45, 1729.26, 1772.48, 1813.24, 1841.73, 1854.5, 1846.64, 1890.84, 1948.3, 2086.31, 2101.04, 2434.03, 2402.1, 2287.67, 2266.55, 2241.51, 2296.02, 2352.5, 2425.19, 2496.4, 2492.47, 2531.27, 2448.76, 2474.3, 2499.84, 2483.14, 2406.52, 2474.3, 2548.95, 2512.12, 2548.95, 2578.42, 2428.63, 2469.39, 2530.78, 2626.55, 2691.38, 2833.31, 2789.6, 2687.45, 2679.59, 2757.68, 2652.09, 2628.51, 2647.18, 3108.84, 3156.97, 3035.17, 2865.24, 2860.82, 2790.1, 2713.48, 2716.92, 2774.38, 2769.47, 2787.64, 2563.69, 2626.55, 2606.9, 2666.82, 2877.02, 2714.46, 2744.42, 2695.31, 2776.83, 2791.57, 2787.15, 2868.18, 2900.6, 3027.31, 3076.42, 3665.78, 3905.45, 3705.07, 3773.82, 3699.17, 3539.06, 3569.51, 3518.44, 3970.27, 4020.37, 3938.84, 3914.29, 3975.19, 3935.9, 3618.63, 3555.76, 3549.87, 3542.01, 3299.39, 3281.71, 3320.02, 3367.17, 3344.58, 3343.6, 3304.31, 3357.35, 3520.4, 3648.1, 3589.16, 3702.12, 3678.54, 3767.0, 3639.0, 3573.0, 3564.0, 3491.0, 3418.0, 3152.0, 3234.0, 3127.0, 3383.0, 3438.0, 3578.0, 3575.0, 3484.0, 3500.0, 3555.0, 3622.0, 3585.0, 3654.0, 3693.0, 3686.0, 3850.0, 3855.0, 3830.0, 3701.0, 3680.0, 3655.0, 3643.0, 3248.0, 3046.0, 2971.0, 2968.5, 3039.0, 2993.0, 2987.0, 2978.5, 2882.5, 2858.0, 2832.0, 2823.0, 2797.0, 2770.5, 2839.0, 2759.5, 2718.0, 2721.5, 2701.5, 2665.5, 2660.0, 2738.5, 2736.5, 2722.0, 2710.0, 2679.0, 2775.5, 2836.5, 2806.0, 2792.0, 2697.5, 2718.0, 2731.5, 2741.0, 2713.0, 2683.0, 2653.5, 2551.0, 2481.5, 2456.5, 2452.0, 2439.5, 2440.0, 2448.0, 2421.0, 2400.0, 2393.5, 2369.0, 2436.5, 2439.5, 2422.5, 2458.0, 2456.0, 2456.5, 2399.0, 2408.0, 2410.5, 2400.0, 2409.0, 2396.5, 2458.5, 2435.0, 2443.0, 2350.0, 2328.5, 2326.0, 2289.0, 2291.0, 2337.0, 2319.5, 2318.0, 2284.0, 2306.5, 2301.5, 2287.5, 2245.5, 2239.0, 2242.0, 2262.0, 2289.0, 2269.5, 2255.5, 2256.0, 2372.0, 2360.0, 2346.5, 2319.0, 2369.5, 2420.0, 2433.5, 2404.5, 2410.0, 2351.0, 2369.5, 2406.0, 2368.0, 2339.0, 2328.0, 2332.0, 2316.5, 2339.0, 2324.0, 2336.0, 2347.0, 2340.0, 2365.0, 2354.0, 2358.5, 2379.5, 2356.0, 2378.5, 2542.0, 2565.0, 2537.0, 2533.0, 2608.0, 2861.0, 2785.5, 2764.5, 2758.0, 2715.0, 2675.5, 2685.5, 2652.0, 2640.0, 2885.0, 2686.0, 2667.5, 2645.0, 2601.5, 2497.0, 2486.5, 2449.0, 2443.0, 2425.0, 2427.0, 2438.5, 2449.5, 2419.0, 2379.0, 2338.0, 2354.0, 2357.5, 2448.0, 2455.5, 2457.5, 2440.0, 2446.5, 2483.0, 2519.5, 2574.0, 2585.5, 2610.0, 2610.0, 2585.0, 2589.0, 2600.0, 2618.0, 2618.0, 2568.5, 2568.0, 2614.5, 2618.0, 2597.5, 2606.5, 2591.5, 2579.5, 2598.0, 2593.5, 2611.5, 2615.0, 2575.5, 2553.0, 2589.5, 2567.5, 2574.0, 2552.5, 2527.5, 2552.5], "lows": [1679.66, 1687.51, 1662.47, 1680.64, 1697.34, 1752.34, 1763.15, 1720.91, 1706.18, 1687.51, 1723.86, 1730.73, 1760.2, 1719.93, 1706.18, 1684.57, 1675.73, 1709.12, 1740.06, 1670.82, 1751.36, 1774.93, 1798.51, 1846.64, 2003.8, 1965.49, 2198.29, 2211.06, 2152.12, 2156.05, 2128.55, 2194.36, 2260.17, 2270.97, 2400.14, 2338.75, 2402.1, 2288.16, 2377.06, 2418.31, 2372.15, 2341.7, 2383.44, 2408.98, 2409.47, 2472.34, 2421.26, 2342.68, 2397.68, 2442.38, 2531.76, 2516.54, 2674.68, 2636.86, 2563.69, 2614.76, 2662.89, 2582.35, 2558.77, 2581.37, 2891.27, 3023.38, 2771.43, 2772.91, 2776.34, 2696.29, 2642.76, 2643.25, 2684.01, 2703.17, 2520.47, 2480.19, 2511.63, 2537.16, 2548.95, 2657.98, 2625.08, 2657.98, 2619.67, 2673.7, 2682.05, 2627.53, 2773.4, 2817.11, 2858.85, 2944.31, 3409.41, 3413.34, 3463.43, 3590.14, 3482.09, 3433.96, 3462.45, 3427.09, 3543.98, 3823.92, 3768.91, 3765.97, 3801.33, 3549.87, 3399.58, 3447.71, 3448.7, 3314.13, 3172.68, 3101.96, 3216.89, 3253.23, 3221.8, 3231.62, 3199.2, 3273.86, 3306.27, 3429.05, 3431.02, 3548.89, 3544.96, 3638.0, 3443.0, 3400.0, 3435.0, 3262.0, 3159.0, 2872.5, 3095.0, 2956.0, 3260.0, 3241.0, 3451.0, 3460.0, 3329.0, 3352.0, 3435.0, 3443.0, 3396.0, 3520.0, 3550.0, 3601.0, 3712.0, 3724.0, 3701.0, 3615.0, 3596.0, 3588.0, 3580.0, 3006.0, 2916.0, 2887.0, 2877.0, 2928.0, 2913.0, 2925.5, 2849.5, 2783.0, 2762.0, 2784.0, 2760.0, 2742.5, 2732.5, 2743.5, 2680.5, 2649.5, 2663.5, 2647.0, 2617.0, 2612.0, 2666.5, 2665.0, 2686.5, 2615.0, 2627.5, 2672.0, 2728.0, 2755.0, 2686.0, 2648.0, 2687.5, 2660.0, 2687.5, 2664.0, 2635.0, 2542.0, 2467.5, 2428.5, 2418.0, 2387.5, 2406.0, 2381.5, 2378.0, 2385.5, 2363.0, 2335.0, 2335.5, 2368.0, 2396.0, 2350.5, 2374.0, 2414.0, 2377.0, 2368.0, 2358.5, 2354.0, 2363.0, 2370.0, 2338.5, 2391.5, 2395.0, 2394.0, 2239.5, 2262.0, 2257.0, 2251.5, 2260.5, 2295.5, 2277.0, 2267.5, 2256.0, 2269.5, 2275.0, 2250.0, 2214.0, 2205.5, 2220.0, 2200.5, 2255.0, 2230.5, 2235.5, 2237.0, 2299.5, 2311.5, 2288.0, 2291.0, 2316.0, 2331.0, 2372.0, 2364.0, 2315.0, 2301.5, 2303.0, 2354.5, 2316.0, 2296.5, 2301.5, 2287.5, 2276.5, 2301.0, 2285.0, 2284.5, 2317.0, 2306.0, 2323.0, 2300.0, 2324.0, 2329.0, 2305.0, 2327.0, 2375.0, 2487.5, 2482.5, 2493.0, 2512.0, 2737.5, 2677.0, 2646.0, 2680.0, 2654.0, 2583.5, 2627.5, 2595.0, 2583.0, 2658.5, 2633.0, 2623.0, 2571.0, 2492.5, 2420.0, 2361.5, 2367.0, 2348.0, 2346.0, 2393.5, 2401.5, 2404.0, 2340.0, 2332.5, 2297.0, 2303.0, 2318.5, 2357.5, 2387.0, 2415.0, 2366.5, 2394.0, 2430.5, 2460.0, 2525.0, 2522.0, 2539.0, 2533.0, 2548.0, 2545.5, 2556.0, 2566.0, 2549.0, 2538.0, 2531.0, 2555.5, 2573.5, 2570.0, 2560.5, 2534.0, 2538.0, 2560.0, 2546.5, 2551.5, 2556.0, 2535.5, 2509.5, 2551.5, 2539.0, 2518.0, 2511.5, 2494.0, 2514.0], "purchase_date": "2024-10-02", "cost_price": 1827, "currency": "JPY", "is_foreign": false};
const isForeign = false;
const currency = 'JPY';
const monthEnd = '2026-01-31';
const repYear = 2026;
const repMonth = 1;
let chart = null;
let period = '6m';
let showJPY = false;

function fmtJPY(v) {
    return new Intl.NumberFormat('ja-JP', {
        style:'currency', currency:'JPY',
        maximumFractionDigits:0
    }).format(v);
}
function fmtForeign(v, cur) {
    try {
        return new Intl.NumberFormat('en-US', {
            style:'currency', currency:cur,
            minimumFractionDigits:2
        }).format(v);
    } catch { return v.toLocaleString(); }
}
function fmtP(v) {
    if (showJPY) return fmtJPY(v);
    if (!isForeign || currency === 'JPY')
        return fmtJPY(v);
    return fmtForeign(v, currency);
}
function pad2(n) { return n < 10 ? '0'+n : ''+n; }

function startDateFor(p) {
    const ey = parseInt(monthEnd.slice(0,4),10);
    const em = parseInt(monthEnd.slice(5,7),10);
    switch(p) {
        case '1m':
            return monthEnd.slice(0,8) + '01';
        case '6m': {
            let sm = em - 6; let sy = ey;
            if (sm <= 0) { sm += 12; sy--; }
            return sy + '-' + pad2(sm) + '-01';
        }
        case '1y':
            return (ey-1) + '-' + pad2(em) + '-01';
        default: return '0000-00-00';
    }
}

function getSlice() {
    const sd = startDateFor(period);
    let si = 0;
    if (period !== 'all') {
        si = S.dates.findIndex(d => d >= sd);
        if (si < 0) si = 0;
    }
    const sl = (arr) => arr ? arr.slice(si) : null;
    return {
        dates: sl(S.dates),
        closes: sl(showJPY && S.closes_jpy
            ? S.closes_jpy : S.closes),
        highs: sl(showJPY && S.highs_jpy
            ? S.highs_jpy : S.highs),
        lows: sl(showJPY && S.lows_jpy
            ? S.lows_jpy : S.lows),
        cost: showJPY && S.cost_price_jpy
            ? S.cost_price_jpy : S.cost_price,
    };
}

function draw() {
    if (chart) chart.destroy();
    const s = getSlice();
    const costLine = s.dates.map(() => s.cost);
    const ctx = document.getElementById('icChart')
        .getContext('2d');
    chart = new Chart(ctx, {
        type:'line',
        data:{
            labels: s.dates,
            datasets:[
                {
                    label:'終値', data:s.closes,
                    borderColor:'#2563eb',
                    backgroundColor:
                        'rgba(37,99,235,0.08)',
                    borderWidth:2.5, tension:0,
                    fill:false,
                    pointRadius: s.dates.length > 90
                        ? 0 : 3,
                    pointHoverRadius:5,
                    pointBackgroundColor:'#2563eb'
                },
                {
                    label:'取得単価', data:costLine,
                    borderColor:'#f59e0b',
                    borderWidth:2,
                    borderDash:[6,4], tension:0,
                    fill:false,
                    pointRadius:0,
                    pointHoverRadius:0
                }
            ]
        },
        options:{
            responsive:true,
            maintainAspectRatio:false,
            plugins:{
                legend:{
                    display:true, position:'top',
                    align:'end'
                },
                tooltip:{
                    mode:'index', intersect:false,
                    callbacks:{
                        title: items =>
                            s.dates[items[0].dataIndex],
                        label: c => {
                            if (c.datasetIndex === 1)
                                return '取得単価: '
                                    + fmtP(c.parsed.y);
                            return '終値: '
                                + fmtP(c.parsed.y);
                        },
                        afterBody: items => {
                            const i = items[0].dataIndex;
                            const lines = [];
                            lines.push('高値: '
                                + fmtP(s.highs[i]));
                            lines.push('安値: '
                                + fmtP(s.lows[i]));
                            const d = s.closes[i]
                                - s.cost;
                            const r = s.cost > 0
                                ? ((d/s.cost)*100)
                                    .toFixed(1) : '0.0';
                            const sg = d>=0?'+':'';
                            lines.push('');
                            lines.push('取得比: '
                                + sg + r + '%');
                            return lines;
                        }
                    }
                }
            },
            scales:{
                x:{
                    ticks:{
                        autoSkip: false,
                        maxRotation: 45,
                        callback: function(val, idx) {
                            const d = s.dates[idx];
                            if (!d) return null;
                            const n = s.dates.length;
                            const p = d.split('-');
                            const y = p[0];
                            const m = parseInt(p[1],10);
                            const day = p[2]
                                ? '/'+parseInt(p[2],10)
                                : '';
                            const full = y+'/'+m+day;
                            const sh = m + day;
                            if (idx === 0
                                || idx === n - 1)
                                return full;
                            if (idx > 0) {
                                const pv =
                                    s.dates[idx-1];
                                if (pv && pv.split(
                                    '-')[0] !== y)
                                    return full;
                            }
                            const step = Math.max(
                                1,
                                Math.floor(n / 10));
                            if (idx % step === 0
                                && (n - idx) > step/2)
                                return sh;
                            return null;
                        }
                    }
                },
                y:{
                    beginAtZero:false,
                    ticks:{ callback: v => fmtP(v) }
                }
            },
            interaction:{
                mode:'nearest', axis:'x',
                intersect:false
            }
        }
    });
    // 情報パネル
    const lc = s.closes[s.closes.length-1];
    const cp = s.cost;
    const df = lc - cp;
    const rt = cp > 0
        ? ((df/cp)*100).toFixed(2) : '0.00';
    const cl = df >= 0 ? 'positive' : 'negative';
    const sg = df >= 0 ? '+' : '';
    const ph = Math.max(...s.highs);
    const pl2 = Math.min(...s.lows);
    let hlLbl;
    if (period === '1m')
        hlLbl = repYear+'年'+repMonth+'月 高値/安値';
    else if (period === '6m')
        hlLbl = '過去6ヶ月 高値/安値';
    else if (period === '1y')
        hlLbl = '過去1年 高値/安値';
    else hlLbl = '全期間 高値/安値';
    document.getElementById('icInfo').innerHTML = `
        <div class="ic-info-item">
            <span class="ic-info-label">取得単価</span>
            <span class="ic-info-value">
                ${fmtP(cp)}</span></div>
        <div class="ic-info-item">
            <span class="ic-info-label">月末終値</span>
            <span class="ic-info-value">
                ${fmtP(lc)}</span></div>
        <div class="ic-info-item">
            <span class="ic-info-label">取得比</span>
            <span class="ic-info-value ${cl}">
                ${sg}${rt}%</span></div>
        <div class="ic-info-item">
            <span class="ic-info-label">${hlLbl}</span>
            <span class="ic-info-value">
                ${fmtP(ph)} / ${fmtP(pl2)}</span>
        </div>`;
}

// 期間切替
document.querySelectorAll('#periodTabs button')
    .forEach(b => {
    b.onclick = () => {
        document.querySelectorAll('#periodTabs button')
            .forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        period = b.dataset.period;
        draw();
    };
});

// 外貨/円切替
const fxEl = document.getElementById('fxToggle');
if (fxEl) {
    fxEl.querySelectorAll('button').forEach(b => {
        b.onclick = () => {
            fxEl.querySelectorAll('button')
                .forEach(x =>
                    x.classList.remove('active'));
            b.classList.add('active');
            showJPY = b.dataset.fx === 'jpy';
            draw();
        };
    });
}

draw();
})();
</script>