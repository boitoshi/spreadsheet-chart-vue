# Portfolio Data Collector

投資ポートフォリオの月次データ収集システム

## 概要
yfinance APIを使用して株価データを取得し、Google Sheetsに転記するPythonアプリケーションです。
外国株の為替レート取得、特定シートのみの更新にも対応しています。

## インストール

```bash
# uvを使用した依存関係のインストール
uv sync

# 開発用依存関係も含める場合（ruff + ty）
uv sync --dev
```

## 使用方法

### 対話型実行
```bash
uv run python main.py
```

対話型メニューから以下の機能を選択できます：
1. **月次データ取得・分析（全シート更新）** - 通常の月次データ収集
2. **期間範囲データ取得・分析（全シート更新）** - 複数月のデータを一括収集
3. **特定シート更新** - 個別シートのみの更新
   - 3-1. 為替レートのみ更新
   - 3-2. 市場データのみ更新
   - 3-3. 損益レポートのみ更新
4. **ポートフォリオサマリー表示** - 指定月の損益サマリー
5. **シート初期化** - 全シートの構造初期化
6. **現在の為替レート表示** - リアルタイム為替レート確認
7. **📝 ブログ記事下書き生成** - 月次投資報告ブログ記事の自動生成

### コマンドライン実行

#### 基本実行
```bash
# 単月実行（2024年12月のデータを取得）
uv run python main.py 2024 12

# 期間範囲実行（2023年6月〜2025年6月）
uv run python main.py --range 2023 6 2025 6
```

#### 特定シート更新
```bash
# 為替レートのみ更新
uv run python main.py --currency-only

# 市場データのみ更新（2024年12月）
uv run python main.py --market-data 2024 12

# 損益レポートのみ更新（2024年12月）
uv run python main.py --performance 2024 12

# ブログ記事下書き生成（2024年12月）
uv run python main.py --blog 2024 12
```

#### スケジューラー実行
```bash
# 月次スケジューラー実行
uv run python schedulers/monthly_runner.py
```

## 環境設定

`.env` ファイルで以下を設定：
```env
SPREADSHEET_ID=your_spreadsheet_id_here
GOOGLE_APPLICATION_CREDENTIALS=/path/to/service-account.json
```

## Google Sheetsの構成

### シート構造
- **ポートフォリオシート** (12カラム A-L): 銘柄管理。日本株はD列に円単価を直接入力、外国株はE列（外貨単価）×F列（為替レート）で管理
- **データ記録シート** (9カラム A-I): 市場データ（月末価格、最高値、最安値、出来高等）
- **損益レポートシート** (16カラム A-P): 計算済み損益データ。L-P列で通貨・外貨建て情報・為替損益分離を記録
- **為替レートシート** (8カラム A-H): 外貨建て株式用の為替レート履歴

### データフロー
1. **ポートフォリオシート** - 手動で保有株式情報を管理
2. **data-collector** - yfinance APIで株価取得、各シートに保存
3. **FastAPI backend** - Google Sheetsからデータ読み取り、JSON API として提供
4. **Next.js frontend** - ダッシュボード表示

## 機能

### 主要機能
- **株価データ自動取得** - yfinance APIを使用
- **外貨建て株式対応** - 為替レート取得・円換算
- **Google Sheets連携** - データの自動転記・保存
- **損益計算** - 取得コストと現在価格から自動計算
- **保有期間フィルタリング** - 取得日以降のみ損益レポートに記録、取得前は市場データのみ
- **期間範囲実行** - 複数月のデータを一括収集
- **📝 ブログ記事自動生成** - 月次投資報告記事の下書き生成

### 特定シート更新機能
- **効率的な部分更新** - 必要なデータのみ更新可能
- **為替レート専用更新** - 毎日の為替レート更新に最適
- **市場データ専用更新** - 株価データのみ更新
- **損益レポート専用更新** - 計算結果のみ更新

### 外貨対応
対応通貨：USD, EUR, GBP, HKD, AUD, CAD, SGD
- 自動為替レート取得（yfinance USDJPY=X等を使用）
- 円換算計算
- 為替レート履歴保存
- **為替損益分離計算**: 株価損益と為替損益を分離して表示
  - 株価損益 = (月末外貨価格 - 取得外貨価格) × 取得時為替レート × 株数
  - 為替損益 = (現在為替レート - 取得時為替レート) × 月末外貨価格 × 株数

## 使用例

### 月次データ収集
```bash
# 2024年12月の全データ収集
uv run python main.py 2024 12
```

### 為替レートの毎日更新
```bash
# 為替レートのみ更新（cron等で毎日実行）
uv run python main.py --currency-only
```

### 過去データの一括収集
```bash
# 2年分のデータを一括収集
uv run python main.py --range 2023 1 2024 12
```

### エラー発生時の部分修復
```bash
# 市場データのみ再取得
uv run python main.py --market-data 2024 12

# 損益計算のみ再実行
uv run python main.py --performance 2024 12
```

### ブログ記事下書き生成
```bash
# 2024年12月の投資報告記事を生成
uv run python main.py --blog 2024 12

# 生成されたファイル: output/blog_draft_2024_12.md
# WordPressにコピー&ペーストして使用
```

**生成される記事の内容**:
- 📊 ポートフォリオサマリー（合計取得額、評価額、総合損益）
- 📈 ポートフォリオ全体の推移チャート画像（6ヶ月分）
- 🇯🇵 日本株・🌏 外国株の銘柄別詳細（損益、市場動向、チャート画像）
- 📊 資産配分（日本株/外国株の比率）
- 📉 銘柄別の株価推移チャート画像（取得日からのデータ）
- グラフ用JSONデータ（Chart.js/Plotly対応）
- エモジを使った見やすい表示

**自動生成される画像**:
- `output/YYYY_MM_charts/portfolio.png` - ポートフォリオ全体の推移
- `output/YYYY_MM_charts/{SYMBOL}.png` - 各銘柄の株価推移

**手動で追記が必要な部分**:
- 各銘柄の定性的なコメント（市場動向の解釈）
- まとめセクションの執筆

**自動判定機能**:
- 銘柄コードから外国株を自動判定（NVDA→米国株、7974.T→日本株）
- 通貨の自動推定（USD、JPY、HKD等）
- 為替レート情報の自動付与

## トラブルシューティング

### よくある問題
1. **Google Sheets認証エラー** - サービスアカウントファイルのパスを確認
2. **yfinance API制限** - 期間範囲実行時は自動的に10秒間隔で実行
3. **銘柄コードエラー** - ポートフォリオシートの銘柄コードを確認

### ログ確認
```bash
# ログファイルの確認
tail -f logs/data_collector.log
```